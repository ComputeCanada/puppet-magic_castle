---
consul_template::version: 0.25.0
consul::version: 1.7.4
consul_template::config_hash:
  consul:
    token: "%{hiera('profile::consul::acl_api_token')}"

fail2ban::package_name: fail2ban-server
fail2ban::jails: ['ssh-route', 'ssh-ban-root']
fail2ban::custom_jails:
  'ssh-route':
    enabled: true
    filter: 'sshd'
    findtime: 3600
    bantime: 86400
    maxretry: 20
    action: 'route'
    logpath: '%(sshd_log)s'
  'ssh-ban-root':
    enabled: true
    findtime: 3600
    bantime: 86400
    maxretry: 0
    action: 'route'
    logpath: '%(sshd_log)s'
    journalmatch: '_SYSTEMD_UNIT=sshd.service + _COMM=sshd'
    filter_maxlines: 10
    filter_includes: 'before = common.conf'
    filter_failregex: '^%(__prefix_line)spam_unix\(sshd:auth\):\s+authentication failure;\s*logname=\S*\s*uid=\d*\s*euid=\d*\s*tty=\S*\s*ruser=\S*\s*rhost=<HOST>\S*\s*user=(root|admin)\s.*$'

jupyterhub::kernel::setup: venv
jupyterhub::kernel::venv::python: /cvmfs/soft.computecanada.ca/easybuild/software/2017/Core/python/3.7.4/bin/python
jupyterhub::kernel::venv::pip_environment:
  PYTHONPATH: "/cvmfs/soft.computecanada.ca/custom/python/site-packages"
  PIP_CONFIG_FILE: "/cvmfs/soft.computecanada.ca/config/python/pip-avx2.conf"

jupyterhub::jupyterhub_config_hash:
SlurmFormSpawner:
  ui_args:
    notebook:
      name: Jupyter Notebook
      modules: ['ipython-kernel/3.7']
    lab:
      name: JupyterLab
      args: ['--SingleUserNotebookApp.default_url=/lab']
      modules: ['ipython-kernel/3.7']
    terminal:
      name: Terminal
      args: ['--SingleUserNotebookApp.default_url=/terminals/1']
    rstudio:
      name: RStudio
      args: ['--SingleUserNotebookApp.default_url=/rstudio']
      modules: ['gcc/7.3.0', 'rstudio-server']
    code-server:
      name: VS Code
      args: ['--SingleUserNotebookApp.default_url=/code-server']
      modules: ['code-server']
    desktop:
      name: Desktop
      args: ['--SingleUserNotebookApp.default_url=/Desktop']

SbatchForm:
  ui:
    choices: ['notebook', 'lab', 'terminal', 'code-server', 'rstudio', 'desktop']
    def: 'lab'

squid::cache_mem: "256 MB"
squid::extra_config_sections:
  general:
    config_entries:
      maximum_object_size: "131072 KB"

profile::squid::server::port: 3128
profile::squid::server::cache_size: 4096
profile::squid::server::cvmfs_acl_regex:
  - '^(cvmfs-.*\.computecanada\.ca)$'
  - '^(cvmfs-.*\.computecanada\.net)$'
  - '^(.*-cvmfs\.openhtc\.io)$'
  - '^(cvmfs-.*\.genap\.ca)$'

profile::cvmfs::client::repositories:
  - cvmfs-config.computecanada.ca
  - soft.computecanada.ca
profile::cvmfs::client::quota_limit: 4096

profile::mfa::mgmt::provider: 'none'
profile::mfa::node::provider: 'none'
profile::mfa::login::provider: 'none'

profile::freeipa::mokey::port: 12345
profile::freeipa::mokey::enable_user_signup: true
profile::freeipa::mokey::require_verify_admin: true

profile::reverse_proxy::jupyterhub_subdomain: jupyter
profile::reverse_proxy::ipa_subdomain: ipa
profile::reverse_proxy::mokey_subdomain: mokey
